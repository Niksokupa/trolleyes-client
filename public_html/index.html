<!DOCTYPE html>
<html lang="es" ng-app="MyApp">

    <head>
        <title>Trolleyes</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta name="description" content="">
        <meta name="author" content="">
        <link rel="icon" href="../../../../favicon.ico">
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
        <link href="css/main.css" rel="stylesheet" type="text/css" />
    </head>

    <body ng-controller="MyController">
        <header ng-include="'header.html'"></header>
        <main role="main" class="container">
            <div class="row" style="margin-top:20px">
                <div class="col-6">
                    <h5>Numero de productos a insertar en la base de datos</h5>
                </div>
                <div class="col-3">
                    <input class="form-control" ng-change="validatorInputInsertar()" ng-model="inputInsertar">
                    <div class="{{alert_box}}" ng-show="diverror">
                        <b>{{mensaje}}</b>
                    </div>
                </div>
                <div class="col-3">
                    <button type="button" ng-click="crearDatos()" class="btn btn-primary" ng-disabled="disabledBotonInsertar">Insertar datos</button>
                </div>
            </div>
            <hr />
            <div class="row mb-3">
                <div class="col-6">
                    <h5>Selecciona el numero de registros por pagina</h5>
                </div>
                <div class="col-4">
                    <select class="custom-select" ng-model="inputGroupSelected" ng-change="inputGroupChange()">
                        <option selected value="5">5</option>
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <table class="table table-hover table-dark">
                        <thead>
                            <tr>
                                <th scope="col">Id</th>
                                <th scope="col">Codigo</th>
                                <th scope="col">Descripcion</th>
                                <th scope="col">Existencias</th>
                                <th scope="col">Precio</th>
                                <th scope="col">Foto</th>
                                <th scope="col">Tipo producto</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr ng-repeat="dato in datos">
                                <th>{{dato.id}}</th>
                                <td>{{dato.codigo}}</td>
                                <td>{{dato.desc}}</td>
                                <td>{{dato.existencias}}</td>
                                <td>{{dato.precio}} â‚¬</td>
                                <td>{{dato.foto}}</td>
                                <td>{{dato.id_tipoProducto}}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="row">
                <div class="col-3 mx-auto">
                    <nav aria-label="Page navigation example">
                        <ul class="pagination">
                            <li ng-class="activeItem" ng-repeat="num in array" ng-click="loadTablePage(num)">
                                <a class="page-link" href="#" ng-click="paginationClick(num)">{{num}}</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </main>
        <footer class="footer" ng-include="'footer.html'"></footer>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.6/angular.min.js"></script>
        <script>
                    var MyModule = angular.module('MyApp', []);
                    MyModule.controller("MyController", ['$scope', '$http', function ($scope, $http) {
                            $scope.inputGroupChange = function () {
                                loadTable($scope.inputGroupSelected, 1);
                            }
                            $scope.diverror = true;
                            $scope.disabledBotonInsertar = true;
                            $scope.diverror = false;
                            var regexOnluNumbers = /(^[1-9]*$)/;
                            var enumMensaje = {"esconder": 1, "mostrar": 2, "correcto": 3, "error": 4};
                            var enumAlertBox = {"correcto": "alert alert-success", "error": "alert alert-danger"}
                            var enumActivePaginator = {"activo": "page-item active", "desactivado": "page-item"}
                            //Expresion regular para el input de generar datos en base de datos
                            $scope.validatorInputInsertar = function () {

                                if (!regexOnluNumbers.test($scope.inputInsertar)) {
                                    mensajeError('', enumMensaje.esconder);
                                    mensajeError('Valido solo caracteres numericos', enumMensaje.mostrar);
                                    $scope.disabledBotonInsertar = true;
                                } else if ($scope.inputInsertar.length === 0) {
                                    mensajeError('', enumMensaje.esconder);
                                    mensajeError('Inserta datos', enumMensaje.mostrar);
                                    $scope.disabledBotonInsertar = true;
                                } else {
                                    mensajeError('', enumMensaje.esconder);
                                    $scope.disabledBotonInsertar = false;
                                }
                            }

                            $scope.crearDatos = function () {
                                $http({
                                    method: 'GET',
                                    withCredentials: true,
                                    url: `http://localhost:8081/trolleyes/json?ob=producto&op=loaddata&number=${$scope.inputInsertar}`
                                }).then(function (response) {
                                    mensajeError(response.data.message, enumMensaje.correcto);
                                }, function (response) {
                                    mensajeError(response.data.message, enumMensaje.error);
                                });
                            }

                            function mensajeError(mensaje, caso) {
                                $scope.diverror = true;
                                switch (caso) {
                                    case enumMensaje.esconder:
                                        $scope.mensaje = '';
                                        $scope.diverror = false;
                                        break;
                                    case enumMensaje.mostrar:
                                        $scope.mensaje = mensaje;
                                        $scope.alert_box = enumAlertBox.error;
                                        break;
                                    case enumMensaje.correcto:
                                        $scope.alert_box = enumAlertBox.correcto;
                                        $scope.mensaje = mensaje;
                                        break;
                                    case enumMensaje.error:
                                        $scope.alert_box = enumAlertBox.error;
                                        $scope.mensaje = mensaje;
                                        break;
                                }
                            }

                            function loadTable(numRegistros, page) {
                                loadPagination(numRegistros);
                                $http({
                                    method: 'GET',
                                    withCredentials: true,
                                    url: `http://localhost:8081/trolleyes/json?ob=producto&op=getpage&rpp=${numRegistros}&page=${page}`
                                }).then(function (response) {
                                    $scope.datos = response.data.message;
                                    //mensajeError(response.data.message, enumMensaje.correcto);
                                }, function (response) {
                                    console.log(response.msg);
                                    //mensajeError(response.data.message, enumMensaje.error);
                                });
                            }
                            var num = 0;
                            function loadPagination(numRegistros) {
                                $http({
                                    method: 'GET',
                                    withCredentials: true,
                                    url: `http://localhost:8081/trolleyes/json?ob=producto&op=getcount`
                                }).then(function (response) {
                                    validarPaginador(response.data.message, numRegistros)
                                    //mensajeError(response.data.message, enumMensaje.correcto);
                                }, function (response) {
                                    console.log(response.msg);
                                    //mensajeError(response.data.message, enumMensaje.error);
                                });
                            }

                            function validarPaginador(response, numRegistros) {
                                if (response > numRegistros) {
                                    var dec = response % numRegistros;
                                    num = response / numRegistros;
                                    if (dec > 0) {
                                        createPaginator(num + 1)
                                    } else {
                                        createPaginator(num);
                                    }
                                } else {
                                    createPaginator(0);
                                }
                            }

                            //Arreglar esto, que es que el numero seleccionado de la paginacion este activado
                            function createPaginator(numero) {
                                var array1 = [];
                                for (i = 1; i <= numero; i++) {
                                    array1[i - 1] = i;
                                    if (i == 1) {
                                        $scope.activeItem = enumActivePaginator.activo;
                                    } else {
                                        $scope.activeItem = enumActivePaginator.desactivado;
                                    }
                                }
                                $scope.array = array1;
                            }

                            $scope.paginationClick = function (num) {
                                $scope.activeItem = enumActivePaginator.activo;
                            }

                            $scope.loadTablePage = function (num) {
                                $http({
                                    method: 'GET',
                                    withCredentials: true,
                                    url: `http://localhost:8081/trolleyes/json?ob=producto&op=getpage&rpp=${$scope.inputGroupSelected}&page=${num}`
                                }).then(function (response) {
                                    $scope.datos = response.data.message;
                                    //mensajeError(response.data.message, enumMensaje.correcto);
                                }, function (response) {
                                    console.log(response.msg);
                                    //mensajeError(response.data.message, enumMensaje.error);
                                });
                            }

                            // $scope.usuarios = function () {
                            //     $http({
                            //         method: 'GET',
                            //         withCredentials: true,
                            //         url: 'http://localhost:8081/trolleyes/json?ob=tipousuario&op=getpage&rpp=10&page=1'
                            //     }).then(function (response) {
                            //         $scope.status = response.status;
                            //         $scope.ajaxDataUsuarios = response.data.message;
                            //     }, function (response) {
                            //         $scope.ajaxDataUsuarios = response.data.message || 'Request failed';
                            //         $scope.status = response.status;
                            //     });
                            // }
                            // $http({
                            //     method: 'GET',
                            //     withCredentials: true,
                            //     url: 'http://localhost:8081/trolleyes/json?ob=tipousuario&op=get&id=2'
                            // }).then(function (response) {
                            //     $scope.status = response.status;
                            //     $scope.ajaxData = response.data.message;
                            // }, function (response) {
                            //     $scope.ajaxData = response.data.message || 'Request failed';
                            //     $scope.status = response.status;
                            // });

                        }]);
        </script>
    </body>

</html>